!function(o){"use strict";var t,r,d=null,i=null;function s(e,n){i.set_type(n.node,"new"),function a(e){o.each(e.children,function(e,n){i.set_type(n,"new"),a(i.get_node(n))})}(n.node)}function c(){i.save_state();var e=JSON.stringify(i.get_json("#",{no_data:!0,no_a_attr:!0,no_li_attr:!0}));o("#pagemanager_json").val(e);e=o("#pagemanager_form");e.find(".xh_success, .xh_fail").remove();var n=o(".pagemanager_status");n.show(),o.post(e.attr("action"),e.serialize()).always(function(){n.hide()}).done(function(e){n.after(e),i.refresh(!1,!0)}).fail(b)}function p(e,n,a,t,r){switch(e){case"rename_node":case"edit":return!/unrenameable/.test(i.get_type(n));case"delete_node":return!PAGEMANAGER.verbose||confirm(PAGEMANAGER.confirmDeletionMessage);default:return!0}}function _(e){for(var n=e,a=0;n&&"#"!==n;)n=i.get_parent(n),a++;return a}function l(e){var a,n=_(e),e=i.get_buffer();return e&&e.node.length&&(n+=(e=e.node[0],a=function(e,n){return e.children&&e.children.length?Math.max.apply(null,o.map(e.children,function(e){return a(e,n+1)})):n},e=i.get_json(e,{no_state:!0,no_id:!0,no_data:!0,no_li_attr:!0,no_a_attr:!0}),a(e,0))),n}function g(e){var n=i.get_buffer();return n&&n.node.length&&i.get_node(n.node[0])===i.get_node(e)}function f(e,n){var a,t=i.get_buffer();t&&t.node.length&&(a=t.node[0]),i.paste(e,n),a&&i.copy(a)}function u(e,n){return[{label:PAGEMANAGER.before,action:function(e){r[n+"Before"](e.reference)},icon:"fa fa-arrow-up",_disabled:"paste"===n&&9<l(e)},{label:PAGEMANAGER.inside,action:function(e){r[n+"Inside"](e.reference)},icon:"fa fa-arrow-right",_disabled:"add"===n?9<=_(e):9<=l(e)||g(e)},{label:PAGEMANAGER.after,action:function(e){r[n+"After"](e.reference)},icon:"fa fa-arrow-down",_disabled:"paste"===n&&9<l(e)}]}function m(e){var n=i.can_paste(),a={open:{},add:{separator_before:!0,submenu:u(e,"add")},rename:{_disabled:/unrenameable$/.test(i.get_type(e))},remove:{_disabled:i.get_children_dom("#").length<2&&_(e)<2},cut:{separator_before:!0},copy:{},paste:{_disabled:!n},edit:{separator_before:!0,_disabled:!i.get_node(e,!0).attr("data-url")},preview:{_disabled:!i.get_node(e,!0).attr("data-url")}};return n&&(a.paste.submenu=u(e,"paste")),o.each(a,function(n,e){e.label=PAGEMANAGER[n+"Op"],e.action=function(e){r[n](e.reference)},e.icon="fa "+PAGEMANAGER.classes[n]}),delete a.add.action,delete a.paste.action,a}function h(e){return PAGEMANAGER.uriCharNew[PAGEMANAGER.uriCharOrg.indexOf(e)]}function A(e,n){var d=i.get_children_dom(e);d&&((d=n?d.not("#"+n.id):d).each(function(e){var n=i.get_type(this).replace(/^duplicate-/,"");i.set_type(this,n)}),d.each(function(e){for(var n=new RegExp(PAGEMANAGER.uriCharOrg.join("|"),"g"),a=i.get_text(this).replace(n,h),t=e+1;t<d.length;t++){var r=i.get_text(d[t]).replace(n,h),o=i.get_type(d[t]);r===a&&i.set_type(d[t],"duplicate-"+o)}}),d.each(function(){A(this,n)}))}function b(e,n,a){alert(a+": "+e.responseText)}o(function(){var e,a,n;void 0!==o.jstree?((e=o("#pagemanager_structure_warning")).length&&(o("#pagemanager_save").hide(),e.find("button").click(function(){e.hide(),o("#pagemanager_save").show()})),(d=o("#pagemanager")).jstree((n={plugins:["contextmenu","dnd","state","types"],core:{animation:PAGEMANAGER.animation,check_callback:p,data:{url:PAGEMANAGER.dataURL,error:b},force_text:!0,multiple:!1,strings:{"Loading ...":PAGEMANAGER.loading},themes:{name:PAGEMANAGER.theme,responsive:!0}},checkbox:{three_state:!1,tie_selection:!1,whole_node:!1},contextmenu:{show_at_node:!1,select_node:!0,items:m},state:{key:PAGEMANAGER.stateKey,events:"",filter:function(e){return delete e.checkbox,e}},types:{new:{icon:"fa fa-folder-open",max_depth:8},unrenameable:{icon:"fa fa-tag",max_depth:8},"duplicate-default":{icon:"fa fa-exclamation-triangle",max_depth:8},"duplicate-new":{icon:"fa fa-exclamation-triangle",max_depth:8},"duplicate-unrenameable":{icon:"fa fa-exclamation-triangle",max_depth:8},default:{icon:"fa fa-folder-open-o",max_depth:8}}},PAGEMANAGER.hasCheckboxes&&n.plugins.push("checkbox"),n)),i=o.jstree.reference(d),r={open:function(e){e=i.get_node(e);i.open_all(e)},addBefore:function(e){var e=i.get_node(e),n=i.get_node(e.parent),e=o.inArray(e.id,n.children),e=i.create_node(n,PAGEMANAGER.newNode,e);i.edit(e)},addInside:function(e){e=i.create_node(e,PAGEMANAGER.newNode);i.edit(e)},addAfter:function(e){var e=i.get_node(e),n=i.get_node(e.parent),e=o.inArray(e.id,n.children),e=i.create_node(n,PAGEMANAGER.newNode,e+1);i.edit(e)},rename:o.proxy(i.edit,i),remove:o.proxy(i.delete_node,i),cut:o.proxy(i.cut,i),copy:o.proxy(i.copy,i),pasteBefore:function(e){var e=i.get_node(e),n=i.get_node(e.parent);f(n,o.inArray(e.id,n.children))},pasteInside:function(e){f(e,"last")},pasteAfter:function(e){var e=i.get_node(e),n=i.get_node(e.parent);f(n,o.inArray(e.id,n.children)+1)},edit:function(e){i.save_state(),location.href=i.get_node(e,!0).attr("data-url")+"&edit"},preview:function(e){i.save_state(),location.href=i.get_node(e,!0).attr("data-url")+"&normal"}},(a=o("#pagemanager_open, #pagemanager_add, #pagemanager_rename, #pagemanager_remove,#pagemanager_cut, #pagemanager_copy, #pagemanager_paste,#pagemanager_edit, #pagemanager_preview")).prop("disabled",!0),d.on("ready.jstree refresh.jstree",function(){t=!1,A("#")}).on("refresh.jstree",function(){i.restore_state()}).on("move_node.jstree create_node.jstree rename_node.jstree delete_node.jstree check_node.jstree uncheck_node.jstree",function(){t=!0}).on("open_node.jstree",function(e,n){A(n.node)}).on("create_node.jstree",function(e,n){i.set_type(n.node,"new"),i.check_node(n.node)}).on("copy_node.jstree",function(e,n){function a(e,n){n=n.replace(/_copy_\d+$/,"")+"_copy_"+(new Date).getTime(),i.set_id(e,n)}a(n.node,n.original.id),o.each(n.node.children_d,function(e){a(this,n.original.children_d[e])});var t,r;t=n.node,r=n.original,i.is_checked(r)&&i.check_node(t),o.each(n.node.children_d,function(e){i.is_checked(n.original.children_d[e])&&i.check_node(this)}),s(0,n)}).on("rename_node.jstree copy_node.jstree move_node.jstree",function(e,n){A(n.node.parent)}).on("delete_node.jstree",function(e,n){A(n.node.parent,n.node)}).on("select_node.jstree",function(e,n){a.prop("disabled",!1),o("#pagemanager_addInside").prop("disabled",9<=_(n.node)),o("#pagemanager_rename").prop("disabled",/unrenameable$/.test(i.get_type(n.node))),o("#pagemanager_remove").prop("disabled",i.get_children_dom("#").length<2&&_(n.node)<2),o("#pagemanager_paste").prop("disabled",!i.can_paste()),o("#pagemanager_pasteBefore, #pagemanager_pasteAfter").prop("disabled",9<l(n.node)),o("#pagemanager_pasteInside").prop("disabled",9<=l(n.node)||g(n.node)),o("#pagemanager_edit, #pagemanager_preview").prop("disabled",!i.get_node(n.node,!0).attr("data-url"))}).on("deselect_node.jstree delete_node.jstree",function(e,n){a.prop("disabled",!0)}).on("cut.jstree copy.jstree",function(e,n){o("#pagemanager_paste").prop("disabled",!i.can_paste()),o("#pagemanager_pasteBefore, #pagemanager_pasteAfter").prop("disabled",9<l(n.node[0])),o("#pagemanager_pasteInside").prop("disabled",9<=l(n.node[0])||g(n.node[0]))}).on("paste.jstree",function(){o("#pagemanager_paste").prop("disabled",!0)}),o(window).on("beforeunload",function(){if(t)return PAGEMANAGER.leaveWarning}),n='<div class="pagemanager_tool_inner"><button id="pagemanager_%sBefore" type="button" title="'+PAGEMANAGER.before+'"><span class="fa fa-arrow-up fa-lg" aria-hidden="true"></span></button><button id="pagemanager_%sInside" type="button" title="'+PAGEMANAGER.inside+'"><span class="fa fa-arrow-right fa-lg" aria-hidden="true"></span></button><button id="pagemanager_%sAfter" type="button" title="'+PAGEMANAGER.after+'"><span class="fa fa-arrow-down fa-lg" aria-hidden="true"></span></button></div>',o("#pagemanager_add, #pagemanager_paste").wrap('<div class="pagemanager_tool_wrapper">'),o("#pagemanager_add").after(n.replace(/%s/g,"add")),o("#pagemanager_paste").after(n.replace(/%s/g,"paste")),o("#pagemanager_toolbar button").click(function(e){!function(e,n){switch(e){case"toggle":var a=!0;return i.get_children_dom("#").each(function(e){i.is_open(this)&&(a=!1)}),a?i.open_all():i.close_all();case"add":case"paste":var t=o("#pagemanager_"+e).next();return t.toggle(),n.stopPropagation(),o(document).one("click",o.proxy(t.hide,t,void 0));case"save":return c();case"help":return open(PAGEMANAGER.userManual,"_blank");default:r[e](i.get_selected())}}(this.id.substr(12),e)}),o("#pagemanager_form").submit(function(e){e.preventDefault(),c()})):alert(PAGEMANAGER.offendingExtensionError)})}(jQuery);